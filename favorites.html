<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorite Companies - JobDetector</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Favorities-specific overrides */
        .dashboard {
            margin-top: 100px;
        }

        /* Collection Cards - MICRO SIZE */
        .collection-card {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: auto;
        }

        .collection-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-blue);
        }

        .collection-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .collection-info h4 {
            margin: 0;
            color: var(--text-main);
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .collection-info p {
            display: none;
        }

        .collection-card .arrow {
            display: none;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        /* --- USER FAVORITES: COMPACT ROW STYLE --- */
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.8rem;
        }

        .company-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .company-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--accent-blue);
        }

        .company-info-compact {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .logo-compact {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .company-name-compact {
            font-size: 0.95rem;
            font-weight: 500;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .company-actions-compact {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .icon-btn.view:hover {
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .icon-btn.remove:hover {
            color: #ff5555;
            background: rgba(255, 85, 85, 0.1);
        }

        .icon-btn.check:hover {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .view-btn-compact {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.85rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            transition: 0.2s;
        }

        .view-btn-compact:hover {
            opacity: 0.9;
        }

        /* Monitor Specific Styles */
        .monitor-card {
            border-left: 3px solid var(--accent-purple);
        }

        .monitor-status {
            font-size: 0.75rem;
            margin-right: 8px;
            white-space: nowrap;
        }

        .status-ok {
            color: #10b981;
        }

        .status-warn {
            color: #f59e0b;
        }

        .status-stale {
            color: #ff5555;
        }

        .monitor-input-group {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }
    </style>
</head>

<body class="dark-theme">
    <!-- Navbar -->
    <nav class="glass-nav">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-satellite-dish"></i>
                <a href="/" style="text-decoration: none; color: inherit;">JobDetector</a>
            </div>

            <div class="nav-links">
                <a href="/" class="nav-item">Jobs</a>
                <a href="/favorites.html" class="nav-item active">Favorites</a>
            </div>

            <div class="user-profile" id="auth-section">
                <!-- Auth content injected by JS -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="section-header">
            <h2>My <span class="gradient-text">Favorites</span></h2>
        </div>

        <!-- Curated Collections -->
        <div class="collections-section"
            style="margin-bottom: 2rem; max-width: 1200px; margin-left: auto; margin-right: auto;">
            <h4
                style="margin-bottom: 1rem; color: var(--text-dim); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">
                Discover Collections</h4>
            <div class="collections-grid">
                <!-- Big Tech -->
                <div class="glass-card collection-card" onclick="viewCollection('bigtech')">
                    <div class="collection-icon" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;"><i
                            class="fas fa-building"></i></div>
                    <div class="collection-info">
                        <h4>Internet Giants</h4>
                    </div>
                </div>
                <!-- AI Innovators -->
                <div class="glass-card collection-card" onclick="viewCollection('ai')">
                    <div class="collection-icon" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;"><i
                            class="fas fa-brain"></i></div>
                    <div class="collection-info">
                        <h4>AI Innovators</h4>
                    </div>
                </div>
                <!-- Fintech -->
                <div class="glass-card collection-card" onclick="viewCollection('fintech')">
                    <div class="collection-icon" style="background: rgba(16, 185, 129, 0.2); color: #10b981;"><i
                            class="fas fa-chart-line"></i></div>
                    <div class="collection-info">
                        <h4>Fintech Leaders</h4>
                    </div>
                </div>
                <!-- Startups -->
                <div class="glass-card collection-card" onclick="viewCollection('startup')">
                    <div class="collection-icon" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;"><i
                            class="fas fa-rocket"></i></div>
                    <div class="collection-info">
                        <h4>High Growth Startups</h4>
                    </div>
                </div>
                <!-- Japan IT -->
                <div class="glass-card collection-card" onclick="viewCollection('japan')">
                    <div class="collection-icon" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;"><i
                            class="fas fa-sun"></i></div>
                    <div class="collection-info">
                        <h4>Japan IT</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add & Manage Favorites -->
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4
                    style="color: var(--text-dim); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin: 0;">
                    My List</h4>
                <a href="/?favorites=true" class="view-btn-compact">
                    <i class="fas fa-layer-group"></i> View All Jobs
                </a>
            </div>

            <!-- Add Form (Compact) -->
            <form id="add-favorite-form" style="display: flex; flex-wrap: wrap; gap: 0.8rem; margin-bottom: 1.5rem;">
                <div class="search-wrapper" style="flex: 1; margin: 0; min-width: 200px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="company-input" placeholder="Company Name (e.g. OpenAI)"
                        style="padding: 0.6rem 0.6rem 0.6rem 2.5rem; height: auto;" required>
                </div>
                <div class="search-wrapper" style="flex: 1; margin: 0; min-width: 200px;">
                    <i class="fas fa-link"></i>
                    <input type="url" id="monitor-input" placeholder="(Optional) Monitor URL for Big Tech"
                        style="padding: 0.6rem 0.6rem 0.6rem 2.5rem; height: auto;">
                </div>
                <button type="submit" class="btn-primary" style="padding: 0.6rem 1.2rem; height: auto;">
                    <i class="fas fa-plus"></i> Add
                </button>
            </form>
            <div id="add-message" style="margin-bottom: 1rem; font-size: 0.85rem; height: 1.2em;"></div>

            <!-- Monitors Section -->
            <div id="monitors-section" style="margin-bottom: 2rem; display: none;">
                <h5
                    style="color: var(--accent-purple); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 10px;">
                    <i class="fas fa-eye"></i> External Monitors (Manual Check)
                </h5>
                <div id="monitors-grid" class="companies-grid"></div>
            </div>

            <!-- Scrapers Grid -->
            <div id="favorites-grid" class="companies-grid">
                <!-- Cards injected by JS -->
                <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-dim);">
                    <i class="fas fa-spinner fa-spin"></i> Loading...
                </div>
            </div>
        </div>
    </main>

    <script src="/js/auth.js"></script>
    <script>
        const API_BASE = '/api';

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (!user) {
                window.location.href = '/?login=true';
                return;
            }
            loadFavorites();
            document.getElementById('add-favorite-form').addEventListener('submit', handleAddFavorite);
        });

        async function loadFavorites() {
            const grid = document.getElementById('favorites-grid');
            const monitorsGrid = document.getElementById('monitors-grid');
            const monitorsSection = document.getElementById('monitors-section');
            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_BASE}/user/favorites`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load');

                const companies = await res.json();

                if (companies.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 3rem; border: 1px dashed var(--border-color); border-radius: 8px;">
                            <p style="color: var(--text-dim);">No favorite companies yet.</p>
                        </div>
                    `;
                    monitorsSection.style.display = 'none';
                    return;
                }

                // Split companies into Monitors vs Scrapers
                const monitors = companies.filter(c => c.is_monitor);
                const scrapers = companies.filter(c => !c.is_monitor);

                // Render Monitors
                if (monitors.length > 0) {
                    monitorsSection.style.display = 'block';
                    monitorsGrid.innerHTML = monitors.map(comp => {
                        const daysSince = getDaysSince(comp.last_checked_at);
                        let statusClass = 'status-ok';
                        let statusText = 'Checked recently';

                        if (daysSince > 14) { statusClass = 'status-stale'; statusText = `${daysSince} days ago`; }
                        else if (daysSince > 7) { statusClass = 'status-warn'; statusText = `${daysSince} days ago`; }

                        return `
                        <div class="company-card monitor-card">
                            <div class="company-info-compact">
                                <div class="logo-compact" style="background: var(--gradient-accent);">${comp.name[0]}</div>
                                <div class="company-name-compact" title="${comp.name}">${comp.name}</div>
                            </div>
                            
                            <div style="display: flex; align-items: center;">
                                <span class="monitor-status ${statusClass}">${statusText}</span>
                                <div class="company-actions-compact">
                                    <button onclick="checkMonitor('${comp.name}', '${comp.monitor_url}')" class="icon-btn check" title="Check Now">
                                        <i class="fas fa-external-link-alt"></i> CHECK
                                    </button>
                                    <button onclick="removeFavorite('${comp.name}')" class="icon-btn remove" title="Remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    monitorsSection.style.display = 'none';
                }

                // Render Scrapers
                if (scrapers.length > 0) {
                    grid.innerHTML = scrapers.map(comp => `
                        <div class="company-card">
                            <div class="company-info-compact">
                                <div class="logo-compact">${comp.name[0]}</div>
                                <div class="company-name-compact" title="${comp.name}">${comp.name}</div>
                            </div>
                            
                            <div class="company-actions-compact">
                                <a href="/?company=${encodeURIComponent(comp.name)}" class="icon-btn view" title="View Jobs">
                                    <i class="fas fa-list"></i>
                                </a>
                                <button onclick="removeFavorite('${comp.name}')" class="icon-btn remove" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-dim); padding: 2rem;">No scraped favorites yet.</div>';
                }

            } catch (err) {
                console.error(err);
                grid.innerHTML = '<div style="color: #ef4444;">Error loading favorites.</div>';
            }
        }

        function getDaysSince(dateString) {
            if (!dateString) return 999;
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        async function handleAddFavorite(e) {
            e.preventDefault();
            const input = document.getElementById('company-input');
            const monitorInput = document.getElementById('monitor-input');
            const msgEl = document.getElementById('add-message');
            const token = localStorage.getItem('token');
            const name = input.value;
            const monitorUrl = monitorInput.value;

            try {
                msgEl.style.color = 'var(--text-dim)';
                msgEl.textContent = 'Adding...';

                const payload = { company_name: name };
                if (monitorUrl) payload.monitor_url = monitorUrl;

                const res = await fetch(`${API_BASE}/user/favorites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    msgEl.style.color = 'var(--accent-green)';
                    msgEl.textContent = `Added ${data.company_name}`;
                    input.value = '';
                    monitorInput.value = '';
                    loadFavorites();
                    setTimeout(() => { msgEl.textContent = ''; }, 3000);
                } else {
                    throw new Error(data.detail || 'Failed to add');
                }
            } catch (err) {
                msgEl.style.color = '#ef4444';
                msgEl.textContent = err.message;
            }
        }

        async function checkMonitor(name, url) {
            // 1. Open URL
            window.open(url, '_blank');

            // 2. Update Timestamp
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_BASE}/user/favorites/${encodeURIComponent(name)}/check`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadFavorites(); // Refresh to update status
            } catch (err) { console.error(err); }
        }

        async function removeFavorite(name) {
            if (!confirm(`Remove ${name}?`)) return;
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/user/favorites/${encodeURIComponent(name)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) loadFavorites();
            } catch (err) { console.error(err); }
        }

        function viewCollection(type) {
            const collections = {
                'bigtech': ['Google', 'Meta', 'Amazon', 'Microsoft', 'Apple', 'Netflix', 'Uber', 'Airbnb', 'Tesla'],
                'ai': ['OpenAI', 'Anthropic', 'Databricks', 'Scale AI', 'Hugging Face', 'Perplexity'],
                'fintech': ['Stripe', 'Block', 'Robinhood', 'Coinbase', 'Affirm', 'Plaid', 'Brex'],
                'startup': ['Notion', 'Figma', 'Canva', 'Rippling', 'Airtable', 'Deel', 'Ramp'],
                'faang_swe': { companies: ['Google', 'Meta', 'Amazon', 'Apple', 'Netflix'], q: 'Software Engineer' },
                'japan': ['Mercari', 'PayPay', 'Rakuten', 'SmartHR', 'Money Forward', 'HENNGE', 'WealthPark', 'Autify']
            };
            const data = collections[type];
            if (!data) return;
            const params = new URLSearchParams();
            if (Array.isArray(data)) data.forEach(c => params.append('companies', c));
            else { data.companies.forEach(c => params.append('companies', c)); if (data.q) params.append('q', data.q); }
            window.location.href = `/?${params.toString()}`;
        }
    </script>
</body>

</html>